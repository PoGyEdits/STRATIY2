<!doctype html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kick Sub Goal Frame</title>
  <style>
    :root {
      --frame-size: 420;
      --stroke-width: 16;
      --radius: 16;
      --track: rgba(255, 255, 255, 0.22);
      --accent-a: #4ade80;
      --accent-b: #22d3ee;
      --text: #f8fafc;
      --text-shadow: rgba(0, 0, 0, 0.8);
      --font: "Segoe UI", Tahoma, sans-serif;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      overflow: hidden;
      font-family: var(--font);
    }

    .overlay {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      pointer-events: none;
    }

    .frame-shell {
      position: relative;
      width: calc(var(--frame-size) * 1px);
      height: calc(var(--frame-size) * 1px);
      filter: drop-shadow(0 0 12px rgba(0, 0, 0, 0.5));
    }

    .frame-svg {
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    .status {
      position: absolute;
      left: 50%;
      bottom: calc(-72px - var(--stroke-width) * 0.3px);
      transform: translateX(-50%);
      min-width: 220px;
      text-align: center;
      color: var(--text);
      text-shadow: 0 2px 8px var(--text-shadow);
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.38);
      backdrop-filter: blur(3px);
    }

    .status .title {
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .status .count {
      margin-top: 3px;
      font-size: 26px;
      font-weight: 800;
      line-height: 1;
    }

    .status .sub {
      margin-top: 6px;
      font-size: 13px;
      opacity: 0.95;
    }

    .status.error {
      background: rgba(120, 20, 20, 0.55);
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="frame-shell">
      <svg id="frameSvg" class="frame-svg" viewBox="0 0 100 100" aria-hidden="true">
        <defs>
          <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="var(--accent-a)" />
            <stop offset="100%" stop-color="var(--accent-b)" />
          </linearGradient>
        </defs>
        <rect id="trackRect" x="8" y="8" width="84" height="84" rx="7" ry="7" fill="none" stroke="var(--track)" stroke-width="4" />
        <rect id="progressRect" x="8" y="8" width="84" height="84" rx="7" ry="7" fill="none" stroke="url(#progressGradient)" stroke-width="4" stroke-linecap="round" transform="rotate(-90 50 50)" />
      </svg>

      <div id="status" class="status">
        <div id="title" class="title">Kick Sub Goal</div>
        <div id="count" class="count">0 / 25</div>
        <div id="sub" class="sub">Zbývá 25 subů</div>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);

    const cfg = {
      channel: (params.get("channel") || "Straty").trim(),
      goal: Math.max(1, Number(params.get("goal") || 25)),
      title: params.get("title") || "Kick Sub Goal",
      refreshMs: Math.max(5000, Number(params.get("refreshMs") || 30000)),
      frameSize: Math.max(180, Number(params.get("size") || 420)),
      stroke: Math.max(4, Number(params.get("stroke") || 16)),
      radius: Math.max(0, Number(params.get("radius") || 16)),
      manualSubs: params.has("subs") ? Math.max(0, Number(params.get("subs"))) : null,
      manualRemaining: params.has("remaining") ? Math.max(0, Number(params.get("remaining"))) : null,
      apiBase: (params.get("api") || "/api/subgoal").trim()
    };

    document.documentElement.style.setProperty("--frame-size", cfg.frameSize);
    document.documentElement.style.setProperty("--stroke-width", cfg.stroke);
    document.documentElement.style.setProperty("--radius", cfg.radius);

    const titleEl = document.getElementById("title");
    const countEl = document.getElementById("count");
    const subEl = document.getElementById("sub");
    const statusEl = document.getElementById("status");
    const trackRect = document.getElementById("trackRect");
    const progressRect = document.getElementById("progressRect");

    titleEl.textContent = cfg.title;

    const viewSize = 100;
    const inset = Math.max(0.5, (cfg.stroke / cfg.frameSize) * viewSize * 0.5);
    const rectSize = viewSize - inset * 2;
    const corner = Math.min((cfg.radius / cfg.frameSize) * viewSize, rectSize / 2);

    for (const el of [trackRect, progressRect]) {
      el.setAttribute("x", inset.toString());
      el.setAttribute("y", inset.toString());
      el.setAttribute("width", rectSize.toString());
      el.setAttribute("height", rectSize.toString());
      el.setAttribute("rx", corner.toString());
      el.setAttribute("ry", corner.toString());
      el.setAttribute("stroke-width", ((cfg.stroke / cfg.frameSize) * viewSize).toString());
    }

    const perimeter = 2 * (rectSize + rectSize) - 8 * corner + 2 * Math.PI * corner;
    progressRect.style.strokeDasharray = `${perimeter}`;

    let lastRatio = 0;
    let liveGoal = cfg.goal;

    function drawProgress(current, goalOverride = null, remainingOverride = null) {
      if (Number.isFinite(goalOverride) && goalOverride > 0) {
        liveGoal = Math.max(1, Math.floor(goalOverride));
      }
      const clampedCurrent = Math.max(0, Number.isFinite(current) ? current : 0);
      const ratio = Math.min(1, clampedCurrent / liveGoal);
      const offset = perimeter * (1 - ratio);

      progressRect.style.transition = "stroke-dashoffset 800ms ease";
      progressRect.style.strokeDashoffset = `${offset}`;
      if (ratio < lastRatio) {
        progressRect.style.transition = "stroke-dashoffset 350ms ease-out";
      }
      lastRatio = ratio;

      const missing = Number.isFinite(remainingOverride) ? Math.max(0, Math.floor(remainingOverride)) : Math.max(0, liveGoal - clampedCurrent);
      countEl.textContent = `${clampedCurrent} / ${liveGoal}`;
      subEl.textContent = missing === 0 ? "Goal splněn" : `Zbývá ${missing} subů`;
      statusEl.classList.remove("error");
    }

    function buildApiUrl() {
      const apiUrl = new URL(cfg.apiBase, window.location.href);
      apiUrl.searchParams.set("channel", cfg.channel);
      apiUrl.searchParams.set("goal", String(cfg.goal));
      return apiUrl.toString();
    }

    async function loadSubs() {
      if (cfg.manualSubs !== null && Number.isFinite(cfg.manualSubs)) {
        drawProgress(cfg.manualSubs);
        return;
      }
      if (cfg.manualRemaining !== null && Number.isFinite(cfg.manualRemaining)) {
        drawProgress(Math.max(0, cfg.goal - cfg.manualRemaining), cfg.goal, cfg.manualRemaining);
        return;
      }

      try {
        const res = await fetch(buildApiUrl(), { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data || !Number.isFinite(data.current)) throw new Error("Invalid API payload");

        drawProgress(data.current, data.goal, data.remaining);
      } catch (err) {
        statusEl.classList.add("error");
        subEl.textContent = "Auto nacteni selhalo. Docasne pouzij ?subs=177";
        console.warn("Sub goal API failed:", err);
      }
    }

    drawProgress(0);
    loadSubs();
    setInterval(loadSubs, cfg.refreshMs);
  </script>
</body>
</html>
